<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ” é’¥åŒ™ç®¡ç†ç³»ç»Ÿ Key Management</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Outfit', 'Noto Sans SC', sans-serif; background: #F8FAFC; color: #1E293B; -webkit-font-smoothing: antialiased; }
  input, select, button { font-family: inherit; }
  input:focus, select:focus { border-color: #4F46E5 !important; box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
  @media print { .no-print { display: none !important; } body { background: #fff; } }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .sync-dot { width:8px; height:8px; border-radius:99px; display:inline-block; }
  .sync-dot.online { background:#22C55E; }
  .sync-dot.offline { background:#EF4444; animation: pulse 1.5s infinite; }
  .sync-dot.loading { background:#F59E0B; animation: pulse 1s infinite; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SUPABASE_URL = "https://prarxhhwfwvyeylimoxk.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Yee4j1rDapRllmk_GcmAkA_NIxRnN5w";

let supabase = null;
let dbReady = false;
try {
  if (SUPABASE_URL && SUPABASE_ANON_KEY && !SUPABASE_URL.includes("YOUR_")) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    dbReady = true;
  }
} catch (e) { console.error("Supabase init error:", e); }

const FLOOR_COLORS = {
  "1F": { bg: "#EEF2FF", accent: "#4F46E5", light: "#C7D2FE", text: "#3730A3", tag: "#E0E7FF" },
  "2F": { bg: "#ECFDF5", accent: "#059669", light: "#A7F3D0", text: "#065F46", tag: "#D1FAE5" },
  "3F": { bg: "#FFF7ED", accent: "#EA580C", light: "#FED7AA", text: "#9A3412", tag: "#FFEDD5" },
  "4F": { bg: "#FAF5FF", accent: "#9333EA", light: "#D8B4FE", text: "#6B21A8", tag: "#F3E8FF" },
};
const LOCK_TYPES = ["æœºæ¢°é”", "æ™ºèƒ½é”", "æŒ‚é”", "æŸœé”", "æ§åˆ¶ç®±é”", "é¥æ§å™¨", "é—¨é”", "å…¶ä»–"];
const TAG_COLORS = {
  "çº¢": { bg: "#DC2626", border: "#B91C1C", text: "#fff", label: "çº¢ Red" },
  "ç™½": { bg: "#FFFFFF", border: "#D1D5DB", text: "#374151", label: "ç™½ White" },
  "é»‘": { bg: "#1F2937", border: "#111827", text: "#fff", label: "é»‘ Black" },
  "ç´«": { bg: "#7C3AED", border: "#6D28D9", text: "#fff", label: "ç´« Purple" },
  "ç»¿": { bg: "#16A34A", border: "#15803D", text: "#fff", label: "ç»¿ Green" },
  "é»„": { bg: "#EAB308", border: "#CA8A04", text: "#1E293B", label: "é»„ Yellow" },
  "æ— ": { bg: "#F3F4F6", border: "#E5E7EB", text: "#9CA3AF", label: "æ—  None" },
};
const STATUS_OPTIONS = ["åœ¨åº“", "åœ¨ç”¨", "å€Ÿå‡º", "é—å¤±", "ç»´ä¿®"];
const STATUS_COLORS = {
  "åœ¨åº“": { bg: "#D1FAE5", text: "#065F46" }, "åœ¨ç”¨": { bg: "#DBEAFE", text: "#1E40AF" },
  "å€Ÿå‡º": { bg: "#FEF3C7", text: "#92400E" }, "é—å¤±": { bg: "#FEE2E2", text: "#991B1B" },
  "ç»´ä¿®": { bg: "#F3E8FF", text: "#6B21A8" },
};
const DEFAULT_KEYS = [
  { id: "k1", boxNum: "1-3", floor: "1F", room: "å¤§é“é—¨ Main Gate", lockType: "é¥æ§å™¨", tagColor: "çº¢", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "ç”µåŠ¨é—¨ï¼Œé¥æ§å™¨x2+å¤‡ç”¨x1" },
  { id: "k2", boxNum: "4-6", floor: "1F", room: "å°é“é—¨ Side Gate", lockType: "æœºæ¢°é”", tagColor: "çº¢", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "" },
  { id: "k3", boxNum: "-", floor: "1F", room: "è¿›å±‹æœ¨é—¨ Front Door", lockType: "æ™ºèƒ½é”", tagColor: "æ— ", qty: 0, spare: 0, holder: "", status: "åœ¨ç”¨", remarks: "å¯†ç /æŒ‡çº¹/APPå¼€é”" },
  { id: "k4", boxNum: "7-8", floor: "1F", room: "å®¢æˆ¿ Guest Room", lockType: "é—¨é”", tagColor: "ç™½", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "" },
  { id: "k5", boxNum: "9", floor: "1F", room: "å…¬ç”¨å•æ‰€ Common Toilet", lockType: "é—¨é”", tagColor: "ç™½", qty: 1, spare: 1, holder: "", status: "åœ¨åº“", remarks: "" },
  { id: "k6", boxNum: "10-11", floor: "1F", room: "å‚¨ç‰©é—´/é˜²ç©ºå£• Storage", lockType: "æŒ‚é”", tagColor: "é»‘", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "é˜²ç©ºå£•æ”¹å‚¨ç‰©é—´" },
  { id: "k7", boxNum: "12", floor: "1F", room: "æ¥¼æ¢¯ä¸‹å‚¨ç‰©é—´ Under-stairs", lockType: "æŒ‚é”", tagColor: "é»‘", qty: 1, spare: 1, holder: "", status: "åœ¨åº“", remarks: "" },
  { id: "k8", boxNum: "13-14", floor: "1F", room: "å¥³ä½£å¥—æˆ¿ Helper Suite", lockType: "é—¨é”", tagColor: "ç™½", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "å«æˆ¿é—¨+å•æ‰€" },
  { id: "k9", boxNum: "15", floor: "1F", room: "ç”µæ¢¯æ§åˆ¶ç®± Lift Control", lockType: "æ§åˆ¶ç®±é”", tagColor: "é»„", qty: 1, spare: 1, holder: "", status: "åœ¨åº“", remarks: "ä»…ç®¡ç†äººå‘˜ä½¿ç”¨" },
  { id: "k10", boxNum: "16", floor: "1F", room: "ç”µæ§åˆ¶ç®± Electrical Panel", lockType: "æ§åˆ¶ç®±é”", tagColor: "é»„", qty: 1, spare: 1, holder: "", status: "åœ¨åº“", remarks: "ä»…ç®¡ç†äººå‘˜/ç”µå·¥ä½¿ç”¨" },
  { id: "k11", boxNum: "17-18", floor: "2F", room: "ä¸»äººæˆ¿ Master Bedroom", lockType: "é—¨é”", tagColor: "ç»¿", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "" },
  { id: "k12", boxNum: "19", floor: "2F", room: "ä¸»äººè¡£å¸½é—´ Walk-in Closet", lockType: "é—¨é”", tagColor: "ç»¿", qty: 1, spare: 1, holder: "", status: "åœ¨åº“", remarks: "" },
  { id: "k13", boxNum: "20", floor: "2F", room: "ä¸»äººå•æ‰€ Master Bathroom", lockType: "é—¨é”", tagColor: "ç»¿", qty: 1, spare: 0, holder: "", status: "åœ¨åº“", remarks: "" },
  { id: "k14", boxNum: "21", floor: "2F", room: "ä¸»äººå‚¨ç‰©æŸœ Master Storage", lockType: "æŸœé”", tagColor: "ç»¿", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "å¤šä¸ªæŸœå­" },
  { id: "k15", boxNum: "22-23", floor: "2F", room: "å®¢æˆ¿å·¦ Guest Left (å¥—æˆ¿)", lockType: "é—¨é”", tagColor: "ç™½", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "å«å•æ‰€" },
  { id: "k16", boxNum: "24-25", floor: "2F", room: "å®¢æˆ¿å³ Guest Right (å¥—æˆ¿)", lockType: "é—¨é”", tagColor: "ç™½", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "å«å•æ‰€" },
  { id: "k17", boxNum: "26-27", floor: "3F", room: "Gavin Lam å¥—æˆ¿", lockType: "é—¨é”", tagColor: "ç´«", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "å«å•æ‰€" },
  { id: "k18", boxNum: "28-29", floor: "3F", room: "Henry Lam å¥—æˆ¿", lockType: "é—¨é”", tagColor: "ç´«", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "å«å•æ‰€" },
  { id: "k19", boxNum: "30-31", floor: "4F", room: "å¥èº«æˆ¿ Gym", lockType: "é—¨é”", tagColor: "çº¢", qty: 2, spare: 1, holder: "", status: "åœ¨åº“", remarks: "" },
  { id: "k20", boxNum: "32", floor: "4F", room: "å¥èº«æˆ¿å‚¨ç‰©æŸœ Gym Storage", lockType: "æŸœé”", tagColor: "çº¢", qty: 1, spare: 1, holder: "", status: "åœ¨åº“", remarks: "" },
];
function genId() { return "k" + Date.now() + Math.random().toString(36).slice(2, 6); }

function StatusBadge({ status }) { const c = STATUS_COLORS[status] || { bg: "#F3F4F6", text: "#374151" }; return <span style={{ background: c.bg, color: c.text, padding: "2px 10px", borderRadius: 99, fontSize: 12, fontWeight: 600, whiteSpace: "nowrap" }}>{status}</span>; }
function FloorTag({ floor }) { const c = FLOOR_COLORS[floor]; if (!c) return <span>{floor}</span>; return <span style={{ background: c.tag, color: c.text, padding: "2px 10px", borderRadius: 99, fontSize: 12, fontWeight: 700 }}>{floor}</span>; }
function TagColorDot({ color, size = 16 }) { const tc = TAG_COLORS[color] || TAG_COLORS["æ— "]; return <span style={{ display: "inline-block", width: size, height: size, borderRadius: 99, background: tc.bg, border: `2px solid ${tc.border}`, boxShadow: "0 1px 3px rgba(0,0,0,0.12)" }} />; }
function TagColorPicker({ value, onChange }) {
  return (<div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>{Object.entries(TAG_COLORS).map(([name, tc]) => (
    <button key={name} onClick={() => onChange(name)} style={{ display: "flex", alignItems: "center", gap: 5, padding: "5px 10px", borderRadius: 8, border: value === name ? `2.5px solid ${tc.border}` : "1.5px solid #E2E8F0", background: value === name ? (name === "ç™½" ? "#F9FAFB" : tc.bg + "18") : "#fff", cursor: "pointer" }}>
      <span style={{ width: 18, height: 18, borderRadius: 99, background: tc.bg, border: `2px solid ${tc.border}` }} /><span style={{ fontSize: 12, fontWeight: 600, color: "#475569" }}>{name}</span>
    </button>))}</div>);
}
function Modal({ open, onClose, title, children }) {
  if (!open) return null;
  return (<div style={{ position: "fixed", inset: 0, zIndex: 1000, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={onClose}>
    <div style={{ position: "absolute", inset: 0, background: "rgba(15,23,42,0.45)", backdropFilter: "blur(4px)" }} />
    <div onClick={e => e.stopPropagation()} style={{ position: "relative", background: "#fff", borderRadius: 16, boxShadow: "0 25px 60px rgba(0,0,0,0.18)", padding: "28px 32px 24px", minWidth: 340, maxWidth: 520, width: "92vw", maxHeight: "88vh", overflowY: "auto" }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 18 }}><h3 style={{ margin: 0, fontSize: 18, fontWeight: 700 }}>{title}</h3><button onClick={onClose} style={{ background: "none", border: "none", fontSize: 22, cursor: "pointer", color: "#94A3B8" }}>âœ•</button></div>{children}
    </div></div>);
}
function FormField({ label, children }) { return (<div style={{ marginBottom: 14 }}><label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#64748B", marginBottom: 4 }}>{label}</label>{children}</div>); }

const inputStyle = { width: "100%", padding: "8px 12px", border: "1.5px solid #E2E8F0", borderRadius: 8, fontSize: 14, outline: "none", fontFamily: "inherit", boxSizing: "border-box" };
const selectStyle = { ...inputStyle, background: "#fff" };
const btnPrimary = { padding: "9px 22px", background: "#4F46E5", color: "#fff", border: "none", borderRadius: 8, fontWeight: 600, fontSize: 14, cursor: "pointer", fontFamily: "inherit" };
const btnSecondary = { ...btnPrimary, background: "#F1F5F9", color: "#475569" };
const btnDanger = { ...btnPrimary, background: "#FEE2E2", color: "#DC2626" };

function KeyForm({ initial, onSave, onCancel }) {
  const [form, setForm] = useState(initial || { boxNum: "", floor: "1F", room: "", lockType: "é—¨é”", tagColor: "æ— ", qty: 1, spare: 0, holder: "", status: "åœ¨åº“", remarks: "" });
  const set = (k, v) => setForm(f => ({ ...f, [k]: v }));
  return (<div>
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0 14px" }}>
      <FormField label="é’¥åŒ™ç®±æŒ‚é’©å· Hook #"><input style={inputStyle} value={form.boxNum} onChange={e => set("boxNum", e.target.value)} placeholder="e.g. 1-3" /></FormField>
      <FormField label="æ¥¼å±‚ Floor"><select style={selectStyle} value={form.floor} onChange={e => set("floor", e.target.value)}>{Object.keys(FLOOR_COLORS).map(f => <option key={f} value={f}>{f}</option>)}</select></FormField>
    </div>
    <FormField label="åŒºåŸŸ/æˆ¿é—´ Room"><input style={inputStyle} value={form.room} onChange={e => set("room", e.target.value)} placeholder="e.g. ä¸»äººæˆ¿" /></FormField>
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0 14px" }}>
      <FormField label="é”å…·ç±»å‹ Lock Type"><select style={selectStyle} value={form.lockType} onChange={e => set("lockType", e.target.value)}>{LOCK_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select></FormField>
      <FormField label="çŠ¶æ€ Status"><select style={selectStyle} value={form.status} onChange={e => set("status", e.target.value)}>{STATUS_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}</select></FormField>
    </div>
    <FormField label="ğŸ·ï¸ é’¥åŒ™ç‰Œé¢œè‰² Tag Color"><TagColorPicker value={form.tagColor || "æ— "} onChange={v => set("tagColor", v)} /></FormField>
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "0 14px" }}>
      <FormField label="é’¥åŒ™æ•°é‡ Qty"><input type="number" min={0} style={inputStyle} value={form.qty} onChange={e => set("qty", parseInt(e.target.value) || 0)} /></FormField>
      <FormField label="å¤‡ç”¨æ•° Spare"><input type="number" min={0} style={inputStyle} value={form.spare} onChange={e => set("spare", parseInt(e.target.value) || 0)} /></FormField>
      <FormField label="æŒæœ‰äºº Holder"><input style={inputStyle} value={form.holder} onChange={e => set("holder", e.target.value)} /></FormField>
    </div>
    <FormField label="å¤‡æ³¨ Remarks"><input style={inputStyle} value={form.remarks} onChange={e => set("remarks", e.target.value)} /></FormField>
    <div style={{ display: "flex", gap: 10, justifyContent: "flex-end", marginTop: 8 }}><button style={btnSecondary} onClick={onCancel}>å–æ¶ˆ</button><button style={btnPrimary} onClick={() => onSave(form)}>ä¿å­˜</button></div>
  </div>);
}
function LogForm({ keys, onSave, onCancel }) {
  const [form, setForm] = useState({ keyId: keys[0]?.id || "", issuedTo: "", reason: "", date: new Date().toISOString().slice(0, 10), returnDate: "", authorizedBy: "" });
  const set = (k, v) => setForm(f => ({ ...f, [k]: v })); const matched = keys.find(k => k.id === form.keyId);
  return (<div>
    <FormField label="é’¥åŒ™ Key"><select style={selectStyle} value={form.keyId} onChange={e => set("keyId", e.target.value)}>{keys.map(k => <option key={k.id} value={k.id}>[{k.floor}] {k.room}</option>)}</select></FormField>
    {matched && <div style={{ fontSize: 12, color: "#94A3B8", marginTop: -10, marginBottom: 10 }}>é’¥åŒ™ç®±: {matched.boxNum} | ç±»å‹: {matched.lockType}</div>}
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0 14px" }}>
      <FormField label="å€Ÿå‡ºæ—¥æœŸ"><input type="date" style={inputStyle} value={form.date} onChange={e => set("date", e.target.value)} /></FormField>
      <FormField label="å½’è¿˜æ—¥æœŸ"><input type="date" style={inputStyle} value={form.returnDate} onChange={e => set("returnDate", e.target.value)} /></FormField>
    </div>
    <FormField label="å€Ÿå‡ºäºº"><input style={inputStyle} value={form.issuedTo} onChange={e => set("issuedTo", e.target.value)} /></FormField>
    <FormField label="åŸå› "><input style={inputStyle} value={form.reason} onChange={e => set("reason", e.target.value)} /></FormField>
    <FormField label="ç»æ‰‹äºº"><input style={inputStyle} value={form.authorizedBy} onChange={e => set("authorizedBy", e.target.value)} /></FormField>
    <div style={{ display: "flex", gap: 10, justifyContent: "flex-end", marginTop: 8 }}><button style={btnSecondary} onClick={onCancel}>å–æ¶ˆ</button><button style={btnPrimary} onClick={() => onSave(form)}>è®°å½•</button></div>
  </div>);
}

function App() {
  const [keys, setKeys] = useState(DEFAULT_KEYS);
  const [logs, setLogs] = useState([]);
  const [loaded, setLoaded] = useState(false);
  const [syncStatus, setSyncStatus] = useState("loading");
  const [view, setView] = useState("dashboard");
  const [floorFilter, setFloorFilter] = useState("ALL");
  const [search, setSearch] = useState("");
  const [modal, setModal] = useState(null);
  const [expandedFloor, setExpandedFloor] = useState(null);
  const skipSync = useRef(false);

  async function loadFromDB() {
    if (!dbReady) { setLoaded(true); return; }
    try {
      const { data: rows, error } = await supabase.from("app_data").select("*");
      if (error) throw error;
      const keysRow = rows?.find(r => r.key === "keys");
      const logsRow = rows?.find(r => r.key === "logs");
      if (keysRow?.value) setKeys(keysRow.value);
      if (logsRow?.value) setLogs(logsRow.value);
      if (!keysRow) await supabase.from("app_data").upsert({ key: "keys", value: DEFAULT_KEYS });
      if (!logsRow) await supabase.from("app_data").upsert({ key: "logs", value: [] });
      setSyncStatus("online");
    } catch (e) { console.error("Load error:", e); setSyncStatus("offline"); }
    setLoaded(true);
  }

  async function saveToDB(dataKey, value) {
    if (!dbReady) return;
    try { await supabase.from("app_data").upsert({ key: dataKey, value }); setSyncStatus("online"); }
    catch (e) { console.error("Save error:", e); setSyncStatus("offline"); }
  }

  useEffect(() => { loadFromDB(); }, []);

  useEffect(() => {
    if (!dbReady) return;
    const channel = supabase.channel("realtime_sync").on("postgres_changes", { event: "*", schema: "public", table: "app_data" }, (payload) => {
      if (skipSync.current) return;
      const row = payload.new;
      if (row?.key === "keys" && row?.value) setKeys(row.value);
      if (row?.key === "logs" && row?.value) setLogs(row.value);
    }).subscribe((status) => { if (status === "SUBSCRIBED") setSyncStatus("online"); });
    return () => { supabase.removeChannel(channel); };
  }, []);

  function syncKeys(nk) { setKeys(nk); skipSync.current = true; saveToDB("keys", nk).then(() => setTimeout(() => { skipSync.current = false; }, 500)); }
  function syncLogs(nl) { setLogs(nl); skipSync.current = true; saveToDB("logs", nl).then(() => setTimeout(() => { skipSync.current = false; }, 500)); }

  const filteredKeys = keys.filter(k => { if (floorFilter !== "ALL" && k.floor !== floorFilter) return false; if (search && !k.room.toLowerCase().includes(search.toLowerCase()) && !k.boxNum.includes(search)) return false; return true; });
  const floorGroups = {}; filteredKeys.forEach(k => { if (!floorGroups[k.floor]) floorGroups[k.floor] = []; floorGroups[k.floor].push(k); });
  const stats = { total: keys.length, totalQty: keys.reduce((s, k) => s + (k.qty||0), 0), totalSpare: keys.reduce((s, k) => s + (k.spare||0), 0), byStatus: STATUS_OPTIONS.map(st => ({ status: st, count: keys.filter(k => k.status === st).length })), byFloor: Object.keys(FLOOR_COLORS).map(f => ({ floor: f, count: keys.filter(k => k.floor === f).length })) };

  function handleSaveKey(form) { if (modal.type === "addKey") syncKeys([...keys, { ...form, id: genId() }]); else if (modal.type === "editKey") syncKeys(keys.map(k => k.id === modal.data.id ? { ...form, id: k.id } : k)); setModal(null); }
  function handleDeleteKey() { syncKeys(keys.filter(k => k.id !== modal.data.id)); setModal(null); }
  function handleSaveLog(form) { const nl = { ...form, id: "log" + Date.now(), createdAt: new Date().toISOString() }; syncLogs([nl, ...logs]); if (form.keyId) syncKeys(keys.map(k => k.id === form.keyId ? { ...k, status: form.returnDate ? "åœ¨åº“" : "å€Ÿå‡º", holder: form.returnDate ? "" : form.issuedTo } : k)); setModal(null); }
  function handleExport() { const d = JSON.stringify({ keys, logs, exportedAt: new Date().toISOString() }, null, 2); const b = new Blob([d], { type: "application/json" }); const u = URL.createObjectURL(b); const a = document.createElement("a"); a.href = u; a.download = "key_backup_" + new Date().toISOString().slice(0,10) + ".json"; a.click(); URL.revokeObjectURL(u); }
  function handleImport() { const input = document.createElement("input"); input.type = "file"; input.accept = ".json"; input.onchange = (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (d.keys) syncKeys(d.keys); if (d.logs) syncLogs(d.logs); alert("å¯¼å…¥æˆåŠŸï¼"); } catch { alert("æ ¼å¼é”™è¯¯"); } }; r.readAsText(f); }; input.click(); }

  if (!loaded) return <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", height: "100vh", gap: 12 }}><div style={{ fontSize: 40 }}>ğŸ”</div><div style={{ color: "#94A3B8" }}>åŠ è½½ä¸­...</div></div>;
  if (!dbReady) return (<div style={{ maxWidth: 500, margin: "60px auto", padding: 24 }}><div style={{ background: "#FEF3C7", border: "2px solid #F59E0B", borderRadius: 12, padding: 24 }}><h2 style={{ margin: "0 0 12px", fontSize: 18, color: "#92400E" }}>âš ï¸ Supabase å°šæœªé…ç½®</h2><p style={{ color: "#78350F", fontSize: 14, lineHeight: 1.6 }}>è¯·æ‰“å¼€ index.htmlï¼Œæ‰¾åˆ°é¡¶éƒ¨çš„ SUPABASE_URL å’Œ SUPABASE_ANON_KEYï¼Œæ›¿æ¢ä¸ºä½ çš„ Supabase é…ç½®ã€‚</p></div></div>);

  function renderDashboard() {
    return (<div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(140px, 1fr))", gap: 14, marginBottom: 28 }}>
        <div style={{ background: "linear-gradient(135deg, #4F46E5, #7C3AED)", borderRadius: 14, padding: "20px 18px", color: "#fff" }}><div style={{ fontSize: 11, opacity: 0.8, fontWeight: 600 }}>æ€»æ¡ç›®</div><div style={{ fontSize: 32, fontWeight: 800, marginTop: 2 }}>{stats.total}</div></div>
        <div style={{ background: "linear-gradient(135deg, #059669, #10B981)", borderRadius: 14, padding: "20px 18px", color: "#fff" }}><div style={{ fontSize: 11, opacity: 0.8, fontWeight: 600 }}>é’¥åŒ™æ€»æ•°</div><div style={{ fontSize: 32, fontWeight: 800, marginTop: 2 }}>{stats.totalQty}</div></div>
        <div style={{ background: "linear-gradient(135deg, #EA580C, #F59E0B)", borderRadius: 14, padding: "20px 18px", color: "#fff" }}><div style={{ fontSize: 11, opacity: 0.8, fontWeight: 600 }}>å¤‡ç”¨é’¥åŒ™</div><div style={{ fontSize: 32, fontWeight: 800, marginTop: 2 }}>{stats.totalSpare}</div></div>
        <div style={{ background: "linear-gradient(135deg, #DC2626, #F87171)", borderRadius: 14, padding: "20px 18px", color: "#fff" }}><div style={{ fontSize: 11, opacity: 0.8, fontWeight: 600 }}>å€Ÿå‡º/é—å¤±</div><div style={{ fontSize: 32, fontWeight: 800, marginTop: 2 }}>{keys.filter(k => k.status === "å€Ÿå‡º" || k.status === "é—å¤±").length}</div></div>
      </div>
      <h3 style={{ fontSize: 15, fontWeight: 700, color: "#334155", marginBottom: 12 }}>ğŸ  æ¥¼å±‚æ¦‚è§ˆ</h3>
      <div style={{ display: "grid", gap: 10, marginBottom: 28 }}>
        {stats.byFloor.map(({ floor, count }) => { const c = FLOOR_COLORS[floor]; const fk = keys.filter(k => k.floor === floor); const isExp = expandedFloor === floor; const labels = { "1F": "ç¬¬ä¸€å±‚ Ground Floor", "2F": "ç¬¬äºŒå±‚ Second Floor", "3F": "ç¬¬ä¸‰å±‚ Third Floor", "4F": "ç¬¬å››å±‚ Fourth Floor" };
          return (<div key={floor}><div onClick={() => setExpandedFloor(isExp ? null : floor)} style={{ background: c.bg, border: `2px solid ${c.light}`, borderRadius: 12, padding: "14px 18px", cursor: "pointer" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><div><span style={{ fontWeight: 800, color: c.accent, fontSize: 18, marginRight: 10 }}>{floor}</span><span style={{ color: c.text, fontSize: 13 }}>{labels[floor]}</span></div><div style={{ display: "flex", alignItems: "center", gap: 12 }}><span style={{ background: c.accent, color: "#fff", borderRadius: 99, padding: "2px 12px", fontSize: 13, fontWeight: 700 }}>{count} é¡¹</span><span style={{ color: c.accent, fontSize: 18, transform: isExp ? "rotate(180deg)" : "none", transition: "transform 0.2s", display: "inline-block" }}>â–¼</span></div></div>
          </div>{isExp && <div style={{ background: "#fff", border: `1.5px solid ${c.light}`, borderTop: "none", borderRadius: "0 0 12px 12px", padding: "8px 6px" }}>
            {fk.map(k => (<div key={k.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "8px 12px", borderBottom: "1px solid #F1F5F9" }}><div style={{ display: "flex", alignItems: "center", gap: 6 }}><TagColorDot color={k.tagColor||"æ— "} size={12} /><span style={{ fontSize: 13, fontWeight: 600 }}>{k.room}</span><span style={{ fontSize: 11, color: "#94A3B8" }}>#{k.boxNum}</span></div><div style={{ display: "flex", alignItems: "center", gap: 8 }}><span style={{ fontSize: 11, color: "#94A3B8" }}>{k.lockType}</span><StatusBadge status={k.status} /></div></div>))}
          </div>}</div>); })}
      </div>
      <h3 style={{ fontSize: 15, fontWeight: 700, color: "#334155", marginBottom: 12 }}>ğŸ“Š çŠ¶æ€ç»Ÿè®¡</h3>
      <div style={{ display: "flex", flexWrap: "wrap", gap: 10, marginBottom: 28 }}>{stats.byStatus.filter(s => s.count > 0).map(({ status, count }) => { const c = STATUS_COLORS[status]; return <div key={status} style={{ background: c.bg, borderRadius: 10, padding: "12px 20px", display: "flex", alignItems: "center", gap: 10 }}><span style={{ fontSize: 22, fontWeight: 800, color: c.text }}>{count}</span><span style={{ fontSize: 13, fontWeight: 600, color: c.text }}>{status}</span></div>; })}</div>
      <h3 style={{ fontSize: 15, fontWeight: 700, color: "#334155", marginBottom: 12 }}>ğŸ·ï¸ é’¥åŒ™ç‰Œé¢œè‰²</h3>
      <div style={{ display: "flex", flexWrap: "wrap", gap: 8, marginBottom: 28 }}>{Object.entries(TAG_COLORS).map(([n, tc]) => { const cnt = keys.filter(k => (k.tagColor||"æ— ") === n).length; if (!cnt) return null; return (<div key={n} style={{ display: "flex", alignItems: "center", gap: 8, background: "#fff", border: `1.5px solid ${tc.border}33`, borderRadius: 10, padding: "10px 16px" }}><span style={{ width: 22, height: 22, borderRadius: 99, background: tc.bg, border: `2px solid ${tc.border}` }} /><div><div style={{ fontSize: 18, fontWeight: 800, lineHeight: 1 }}>{cnt}</div><div style={{ fontSize: 11, color: "#94A3B8" }}>{tc.label}</div></div></div>); })}</div>
      {logs.length > 0 && <div style={{ marginBottom: 28 }}><h3 style={{ fontSize: 15, fontWeight: 700, color: "#334155", marginBottom: 12 }}>ğŸ“ æœ€è¿‘å€Ÿè¿˜</h3>{logs.slice(0, 5).map(log => { const k = keys.find(x => x.id === log.keyId); return <div key={log.id} style={{ padding: "10px 14px", background: "#F8FAFC", borderRadius: 8, marginBottom: 6, display: "flex", justifyContent: "space-between" }}><div><span style={{ fontWeight: 600, fontSize: 13 }}>{k?.room || "æœªçŸ¥"}</span><span style={{ fontSize: 12, color: "#94A3B8", marginLeft: 8 }}>â†’ {log.issuedTo}</span></div><span style={{ fontSize: 12, color: "#94A3B8" }}>{log.date}</span></div>; })}</div>}
      <h3 style={{ fontSize: 15, fontWeight: 700, color: "#334155", marginBottom: 12 }}>âš™ï¸ æ•°æ®ç®¡ç†</h3>
      <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}><button style={{ ...btnSecondary, fontSize: 13 }} onClick={handleExport}>ğŸ“¥ å¯¼å‡ºå¤‡ä»½</button><button style={{ ...btnSecondary, fontSize: 13 }} onClick={handleImport}>ğŸ“¤ å¯¼å…¥æ•°æ®</button></div>
    </div>);
  }

  function renderKeys() {
    return (<div>
      <div style={{ display: "flex", gap: 10, marginBottom: 18, flexWrap: "wrap" }}>
        <input style={{ ...inputStyle, flex: 1, minWidth: 160 }} placeholder="ğŸ” æœç´¢..." value={search} onChange={e => setSearch(e.target.value)} />
        <div style={{ display: "flex", gap: 4 }}>{["ALL", ...Object.keys(FLOOR_COLORS)].map(f => <button key={f} onClick={() => setFloorFilter(f)} style={{ padding: "7px 14px", borderRadius: 8, border: "none", fontSize: 13, fontWeight: 600, cursor: "pointer", background: floorFilter === f ? "#4F46E5" : "#F1F5F9", color: floorFilter === f ? "#fff" : "#64748B" }}>{f === "ALL" ? "å…¨éƒ¨" : f}</button>)}</div>
        <button style={btnPrimary} onClick={() => setModal({ type: "addKey" })}>ï¼‹ æ–°å¢</button>
      </div>
      {Object.entries(floorGroups).map(([floor, fKeys]) => { const c = FLOOR_COLORS[floor]; return (<div key={floor} style={{ marginBottom: 20 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}><div style={{ width: 4, height: 20, borderRadius: 2, background: c.accent }} /><span style={{ fontWeight: 700, fontSize: 14, color: c.accent }}>{floor}</span><span style={{ fontSize: 12, color: "#94A3B8" }}>({fKeys.length})</span></div>
        {fKeys.map(k => (<div key={k.id} style={{ background: "#fff", border: "1.5px solid #E2E8F0", borderRadius: 10, padding: "12px 16px", marginBottom: 8, borderLeft: `4px solid ${c.accent}`, cursor: "pointer" }} onClick={() => setModal({ type: "editKey", data: k })}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", flexWrap: "wrap", gap: 6 }}>
            <div><span style={{ display: "inline-flex", alignItems: "center", gap: 6 }}><TagColorDot color={k.tagColor||"æ— "} size={14} /><span style={{ fontWeight: 700, fontSize: 14 }}>{k.room}</span></span>
              <div style={{ display: "flex", gap: 6, marginTop: 4, flexWrap: "wrap", alignItems: "center" }}>
                <span style={{ fontSize: 11, color: "#94A3B8", background: "#F1F5F9", padding: "1px 8px", borderRadius: 4 }}>ğŸ”‘ ç®±#{k.boxNum}</span>
                <span style={{ fontSize: 11, color: "#94A3B8", background: "#F1F5F9", padding: "1px 8px", borderRadius: 4 }}>{k.lockType}</span>
                {k.tagColor && k.tagColor !== "æ— " && <span style={{ fontSize: 11, color: "#94A3B8", background: "#F1F5F9", padding: "1px 8px", borderRadius: 4, display: "inline-flex", alignItems: "center", gap: 3 }}><TagColorDot color={k.tagColor} size={10} />{k.tagColor}ç‰Œ</span>}
                <span style={{ fontSize: 11, color: "#94A3B8", background: "#F1F5F9", padding: "1px 8px", borderRadius: 4 }}>x{k.qty} +å¤‡{k.spare}</span>
                {k.holder && <span style={{ fontSize: 11, color: "#EA580C", background: "#FFF7ED", padding: "1px 8px", borderRadius: 4 }}>ğŸ‘¤ {k.holder}</span>}
              </div></div><StatusBadge status={k.status} /></div>
          {k.remarks && <div style={{ fontSize: 11, color: "#94A3B8", marginTop: 6, fontStyle: "italic" }}>ğŸ’¬ {k.remarks}</div>}
        </div>))}
      </div>); })}
      {filteredKeys.length === 0 && <div style={{ textAlign: "center", padding: 40, color: "#94A3B8" }}>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•</div>}
    </div>);
  }

  function renderLogs() {
    return (<div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 18 }}><span style={{ fontSize: 13, color: "#94A3B8" }}>å…± {logs.length} æ¡</span><button style={btnPrimary} onClick={() => setModal({ type: "addLog" })}>ï¼‹ æ–°å¢å€Ÿè¿˜</button></div>
      {logs.length === 0 ? <div style={{ textAlign: "center", padding: 50, color: "#94A3B8" }}><div style={{ fontSize: 40, marginBottom: 10 }}>ğŸ“‹</div><div>æš‚æ— å€Ÿè¿˜è®°å½•</div></div>
      : logs.map(log => { const k = keys.find(x => x.id === log.keyId); return (<div key={log.id} style={{ background: "#fff", border: "1.5px solid #E2E8F0", borderRadius: 10, padding: "14px 18px", marginBottom: 8 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: 6 }}><div style={{ display: "flex", alignItems: "center", gap: 8 }}><span style={{ fontWeight: 700, fontSize: 14 }}>{k?.room || "å·²åˆ é™¤"}</span>{k && <FloorTag floor={k.floor} />}</div>{log.returnDate ? <span style={{ background: "#D1FAE5", color: "#065F46", padding: "2px 10px", borderRadius: 99, fontSize: 12, fontWeight: 600 }}>å·²å½’è¿˜</span> : <span style={{ background: "#FEF3C7", color: "#92400E", padding: "2px 10px", borderRadius: 99, fontSize: 12, fontWeight: 600 }}>å€Ÿå‡ºä¸­</span>}</div>
        <div style={{ display: "flex", gap: 16, marginTop: 8, flexWrap: "wrap", fontSize: 12, color: "#64748B" }}><span>ğŸ‘¤ {log.issuedTo}</span><span>ğŸ“… {log.date}</span>{log.returnDate && <span>â†©ï¸ {log.returnDate}</span>}{log.reason && <span>ğŸ“ {log.reason}</span>}{log.authorizedBy && <span>âœ… {log.authorizedBy}</span>}</div>
      </div>); })}
    </div>);
  }

  const NAV = [{ key: "dashboard", label: "æ€»è§ˆ", icon: "ğŸ“Š" }, { key: "keys", label: "é’¥åŒ™", icon: "ğŸ”‘" }, { key: "logs", label: "å€Ÿè¿˜", icon: "ğŸ“‹" }];
  const syncLabel = { online: "å·²åŒæ­¥", offline: "ç¦»çº¿", loading: "è¿æ¥ä¸­..." };
  return (<div style={{ minHeight: "100vh" }}>
    <div className="no-print" style={{ background: "linear-gradient(135deg, #1E293B 0%, #334155 100%)", padding: "20px 24px 16px", color: "#fff" }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", maxWidth: 640, margin: "0 auto" }}>
        <div><h1 style={{ margin: 0, fontSize: 22, fontWeight: 800 }}>ğŸ” é’¥åŒ™ç®¡ç†</h1><div style={{ fontSize: 12, opacity: 0.6, marginTop: 2, display: "flex", alignItems: "center", gap: 6 }}>Key Management <span className={`sync-dot ${syncStatus}`} /><span style={{ fontSize: 10, opacity: 0.5 }}>{syncLabel[syncStatus]}</span></div></div>
        <div style={{ fontSize: 12, opacity: 0.5, textAlign: "right" }}>å…± {keys.length} æ¡<br />{keys.reduce((s, k) => s + (k.qty||0) + (k.spare||0), 0)} æŠŠé’¥åŒ™</div>
      </div>
      <div style={{ display: "flex", gap: 4, marginTop: 16, maxWidth: 640, margin: "16px auto 0" }}>{NAV.map(item => <button key={item.key} onClick={() => setView(item.key)} style={{ flex: 1, padding: "10px 0", border: "none", borderRadius: "10px 10px 0 0", fontSize: 14, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", background: view === item.key ? "#F8FAFC" : "rgba(255,255,255,0.08)", color: view === item.key ? "#1E293B" : "rgba(255,255,255,0.6)" }}>{item.icon} {item.label}</button>)}</div>
    </div>
    <div style={{ padding: "20px 16px 100px", maxWidth: 640, margin: "0 auto" }}>{view === "dashboard" && renderDashboard()}{view === "keys" && renderKeys()}{view === "logs" && renderLogs()}</div>
    <Modal open={modal?.type === "addKey"} onClose={() => setModal(null)} title="æ–°å¢é’¥åŒ™"><KeyForm onSave={handleSaveKey} onCancel={() => setModal(null)} /></Modal>
    <Modal open={modal?.type === "editKey"} onClose={() => setModal(null)} title="ç¼–è¾‘é’¥åŒ™">{modal?.data && (<><KeyForm initial={modal.data} onSave={handleSaveKey} onCancel={() => setModal(null)} /><div style={{ borderTop: "1px solid #F1F5F9", marginTop: 16, paddingTop: 12 }}><button style={btnDanger} onClick={() => setModal({ type: "deleteKey", data: modal.data })}>ğŸ—‘ åˆ é™¤æ­¤æ¡</button></div></>)}</Modal>
    <Modal open={modal?.type === "deleteKey"} onClose={() => setModal(null)} title="ç¡®è®¤åˆ é™¤?"><p style={{ color: "#64748B", fontSize: 14 }}>ç¡®å®šè¦åˆ é™¤ã€Œ{modal?.data?.room}ã€å—ï¼Ÿ</p><div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}><button style={btnSecondary} onClick={() => setModal({ type: "editKey", data: modal.data })}>å–æ¶ˆ</button><button style={{ ...btnPrimary, background: "#DC2626" }} onClick={handleDeleteKey}>ç¡®è®¤åˆ é™¤</button></div></Modal>
    <Modal open={modal?.type === "addLog"} onClose={() => setModal(null)} title="æ–°å¢å€Ÿè¿˜è®°å½•"><LogForm keys={keys} onSave={handleSaveLog} onCancel={() => setModal(null)} /></Modal>
  </div>);
}
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
